name: ğŸ”’ Npm Audit & Auto-Fix

on:
  schedule:
    - cron: "0 9 * * 1" # Every monday at 09:00
  workflow_dispatch: # Allow manual execution
  push:
    paths:
      - "package*.json"

jobs:
  npm-audit-and-fix:
    name: NPM Audit & Fix
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code â¬‡
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: ğŸ“¥ Install Dependencies
        run: npm ci

      - name: ğŸ” Security Check (Before Fix)
        run: |
          echo "## ğŸ“Š NPM Security Report" > audit-report.md
          echo "" >> audit-report.md
          echo "### ğŸ” Security Check Results (Before Fix):" >> audit-report.md
          echo '```bash' >> audit-report.md
          npm run security:check >> audit-report.md 2>&1 || echo "Vulnerabilities found - proceeding with fixes..." >> audit-report.md
          echo '```' >> audit-report.md
          echo "" >> audit-report.md

      - name: ğŸ“Š Generate Detailed Audit Report (Before)
        run: |
          echo "### ğŸ“‹ Detailed Vulnerability Report:" >> audit-report.md
          echo '```json' >> audit-report.md
          npm run security:report >> audit-report.md 2>&1 || true
          echo '```' >> audit-report.md
          echo "" >> audit-report.md

      - name: ğŸ› ï¸ Apply Security Fixes
        id: security-fix
        run: |
          # Backup current state
          cp package-lock.json package-lock.json.backup || true

          # Apply fixes using your script
          npm run security:fix || true

          # Check if changes were made
          if ! diff -q package-lock.json package-lock.json.backup > /dev/null 2>&1; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Security fixes applied successfully!"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No vulnerabilities to fix"
          fi

      - name: âœ… Security Check (After Fix)
        if: steps.security-fix.outputs.changes == 'true'
        run: |
          echo "### âœ… Security Check Results (After Fix):" >> audit-report.md
          echo '```bash' >> audit-report.md
          npm run security:check >> audit-report.md 2>&1 || echo "Some issues may still remain - please review manually" >> audit-report.md
          echo '```' >> audit-report.md
          echo "" >> audit-report.md

      - name: ğŸ“‹ Document Changes Made
        if: steps.security-fix.outputs.changes == 'true'
        run: |
          echo "### ğŸ“‹ Files Changed:" >> audit-report.md
          echo '```bash' >> audit-report.md
          git diff --name-only >> audit-report.md
          echo '```' >> audit-report.md
          echo "" >> audit-report.md
          echo "### ğŸ”„ Package Changes:" >> audit-report.md
          echo '```diff' >> audit-report.md
          git diff package-lock.json | head -50 >> audit-report.md || true
          echo '```' >> audit-report.md
          echo "" >> audit-report.md

      - name: ğŸ§ª Run Tests
        if: steps.security-fix.outputs.changes == 'true'
        run: |
          echo "### ğŸ§ª Test Results:" >> audit-report.md
          if npm test; then
            echo "âœ… **All tests passed!** Changes are safe to merge." >> audit-report.md
          else
            echo "âŒ **Tests failed!** Please review changes carefully before merging." >> audit-report.md
            echo "" >> audit-report.md
            echo "âš ï¸ **Action Required:** Manual review needed due to test failures." >> audit-report.md
          fi
          echo "" >> audit-report.md

      - name: ğŸ”„ Create Pull Request
        if: steps.security-fix.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            ğŸ”’ chore(security): fix npm audit vulnerabilities

            - Auto-generated security fixes via npm run security:fix
            - Executed security checks via npm run security:check
            - Run by GitHub Actions on schedule
          title: "ğŸ”’ Security: Auto-fix npm audit vulnerabilities"
          body-path: audit-report.md
          branch: security/auto-fix-vulnerabilities-${{ github.run_number }}
          delete-branch: true
          labels: |
            security
            dependencies
            automated
          reviewers: ${{ github.actor }}
          draft: false

      - name: ğŸ“¢ Summary
        run: |
          if [ "${{ steps.security-fix.outputs.changes }}" == "true" ]; then
            echo "âœ… Security fixes applied using 'npm run security:fix'"
            echo "ğŸ” Security validated using 'npm run security:check'"
            echo "ğŸ“‹ Pull request created for your review"
            echo ""
            echo "ğŸ¯ Next steps:"
            echo "   1. Review the automated PR"
            echo "   2. Check if tests passed"
            echo "   3. Merge when satisfied"
          else
            echo "â„¹ï¸ No security vulnerabilities found via 'npm run security:check'"
            echo "ğŸ‰ Your project is secure! All good!"
          fi
